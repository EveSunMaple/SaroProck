---
import { type CollectionEntry, getCollection } from "astro:content";
import SidebarPanel from "./SidebarPanel";
import type { MarkdownHeading } from "astro";

export interface Props {
  author: string;
  twitterHandle: string;
  githubUrl: string;
  telegramUrl: string;
  headings?: MarkdownHeading[];
  channelUrl: string;
  qqGroupNumber: string;
  emailAddress: string;
}

const {
  headings,
  author,
  twitterHandle,
  githubUrl,
  telegramUrl,
  channelUrl,
  qqGroupNumber,
  emailAddress,
} = Astro.props;

// 动态统计数据 (无改动)
const allPosts = await getCollection(
  "blog",
  ({ data }: CollectionEntry<"blog">) => data.draft !== true,
);
const countWords = (text: string) => {
  text = text.replace(/[\u3000-\u303F\uFF00-\uFFEF]/g, "");
  text = text.replace(/[`*~_#+\-![\]{}()>|]/g, "");
  const cjkChars = text.match(/[\u4e00-\u9fa5]/g)?.length || 0;
  const otherWords =
    text.replace(/[\u4e00-\u9fa5]/g, " ").match(/\b\w+\b/g)?.length || 0;
  return cjkChars + otherWords;
};
const totalWords = allPosts.reduce(
  (acc: number, post: CollectionEntry<"blog">) => acc + countWords(post.body),
  0,
);
const formattedTotalWords =
  totalWords > 1000 ? `${(totalWords / 1000).toFixed(1)}k` : totalWords;
const stats = {
  articles: allPosts.length,
  words: formattedTotalWords,
};

const contacts = {
  qqGroup: qqGroupNumber,
  email: emailAddress,
};
---

<SidebarPanel
  client:load
  headings={headings}
  author={author}
  twitterHandle={twitterHandle}
  githubUrl={githubUrl}
  telegramUrl={telegramUrl}
  channelUrl={channelUrl}
  stats={stats}
  contacts={contacts}
/>
